<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Processing climate projection data • CFtime</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Processing climate projection data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CFtime</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.7.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cftime.html">Working with CFtime</a></li>
    <li><a class="dropdown-item" href="../articles/conformance.html">Conformance with the CF Metadata Conventions</a></li>
    <li><a class="dropdown-item" href="../articles/processing.html">Processing climate projection data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/R-CF/CFtime/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Processing climate projection data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/R-CF/CFtime/blob/main/vignettes/articles/processing.Rmd" class="external-link"><code>vignettes/articles/processing.Rmd</code></a></small>
      <div class="d-none name"><code>processing.Rmd</code></div>
    </div>

    
    
<p>Climate projection data sets are produced in a variety of formats but
all conform to the CF Metadata Conventions. NetCDF data files, in
particular, are highly structured and relatively easy to process. That
said, it is very important to maintain a proper processing workflow such
that the small changes in the climate projections are maintained and
revealed through analysis. In this document, the basic workflow with
varying calendars is described.</p>
<blockquote>
<p>In this vignette we are using the <a href="https://cran.r-project.org/package=ncdfCF" class="external-link"><code>ncdfCF</code>
package</a> as that provides the easiest interface to work with netCDF
files. Package <code>CFtime</code> is integrated into
<code>ncdfCF</code> which makes working with time dimensions in netCDF
seamless.<br>
Packages <code>RNetCDF</code> and <code>ncdf4</code> can work with
<code>CFtime</code> as well but then the “intelligence” built into
<code>ncdfCF</code> is not available, such as automatically identifying
axes and data orientation. Other packages like <code>terra</code> and
<code>stars</code> are not recommended because they do not provide
access to the specifics of the time dimension of the data and do not
consider any calendars other than “proleptic_gregorian”.</p>
</blockquote>
<div class="section level2">
<h2 id="processing-climate-projection-data">Processing climate projection data<a class="anchor" aria-label="anchor" href="#processing-climate-projection-data"></a>
</h2>
<p>Individual files containing climate projections contain global,
regional or local data, typically on a rectangular latitude-longitude
grid, for a single parameter such as “near-surface temperature”, and for
a number of time steps. An analysis workflow then consists of a number
of steps:</p>
<ul>
<li>Download the appropriate data files for your desired combination of
model, experiment, realization, geography, time range, parameter, …
(called a “data suite” henceforth). If your analysis involves multiple
parameters (such as temperature and precipitation to estimate crop
productivity), repeat the process for all parameters. If you want to
make a multi-model ensemble to reduce model bias, repeat again for all
desired model, experiment and realization combinations (“ensemble
member”). You end up having one or more data suites to work with.</li>
<li>Take all files in a data suite and extract the data. Process the
data in the data suite. Since the data are (mostly) 3-dimensional
arrays, this will involve binding the arrays on the right dimension and
then do something like <code>apply(data, 1:2, tapply, f, fun)</code>
(following the CF Metadata Conventions, dimensions 1 and 2 are
“longitude” and “latitude”, respectively; the third dimension is “time”;
none of this is standardized though and deviations are out there;
package <code>ncdfCF</code> can help with the
<code>CFVariable$array()</code> method). Repeat for the data suite for
each ensemble member.</li>
<li>Combine the above results as your workflow requires. Frequently this
involves computing “anomalies”: ratio the data for one or more future
periods to a baseline period. Repeat for each ensemble member.</li>
<li>Construct the multi-model ensemble from the individual ensemble
members.</li>
</ul>
<p>Apart from the first step of obtaining the data, the steps lend
themselves well to automation. The catch, however, is in the factor
<code>f</code> to use with <code><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply()</a></code>. The different models
(in your ensemble) use different calendars, meaning that different
factors are required. The <code>CFtime</code> package can help out.</p>
<p>The <code>CFTime$factor()</code> method produces a factor that
respects the calendar of the data files. The method comes in two
operating modes:</p>
<ul>
<li>Plain vanilla mode produces a factor for a time period across the
entire time series. The factor level includes the year. This would be
useful to calculate mean temperature for every month in every year, for
instance.</li>
<li>When one or more “eras” (periods of interest) are provided, the
factor level no longer includes the year and can be used to calculate,
for instance, the mean temperature per period of interest in the era
(e.g. average March temperature in the era 2041-2060).</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setting up</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/R-CF/ncdfCF" class="external-link">ncdfCF</a></span><span class="op">)</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"CFtime"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">(</span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">ncdfCF</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdfCF/man/open_ncdf.html" class="external-link">open_ncdf</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;Dataset&gt; pr_day_GFDL-ESM4_ssp245_r1i1p1f1_gr1_20150101-20991231_v20180701 </span></span>
<span><span class="co">#&gt; Resource   : /home/runner/work/_temp/Library/CFtime/extdata/pr_day_GFDL-ESM4_ssp245_r1i1p1f1_gr1_20150101-20991231_v20180701.nc </span></span>
<span><span class="co">#&gt; Format     : netcdf4 </span></span>
<span><span class="co">#&gt; Collection : CMIP6 </span></span>
<span><span class="co">#&gt; Conventions: CF-1.7 CMIP-6.0 UGRID-1.0 </span></span>
<span><span class="co">#&gt; Has groups : FALSE </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Variable:</span></span>
<span><span class="co">#&gt;  name long_name     units      data_type axes          </span></span>
<span><span class="co">#&gt;  pr   Precipitation kg m-2 s-1 NC_FLOAT  lon, lat, time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; External variable: areacella</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attributes:</span></span>
<span><span class="co">#&gt;  name                  type      length</span></span>
<span><span class="co">#&gt;  external_variables    NC_CHAR     9   </span></span>
<span><span class="co">#&gt;  history               NC_CHAR   124   </span></span>
<span><span class="co">#&gt;  table_id              NC_CHAR     3   </span></span>
<span><span class="co">#&gt;  activity_id           NC_CHAR    11   </span></span>
<span><span class="co">#&gt;  branch_method         NC_CHAR     8   </span></span>
<span><span class="co">#&gt;  branch_time_in_child  NC_DOUBLE   1   </span></span>
<span><span class="co">#&gt;  branch_time_in_parent NC_DOUBLE   1   </span></span>
<span><span class="co">#&gt;  comment               NC_CHAR    10   </span></span>
<span><span class="co">#&gt;  contact               NC_CHAR    32   </span></span>
<span><span class="co">#&gt;  Conventions           NC_CHAR    25   </span></span>
<span><span class="co">#&gt;  creation_date         NC_CHAR    20   </span></span>
<span><span class="co">#&gt;  data_specs_version    NC_CHAR     8   </span></span>
<span><span class="co">#&gt;  experiment            NC_CHAR    30   </span></span>
<span><span class="co">#&gt;  experiment_id         NC_CHAR     6   </span></span>
<span><span class="co">#&gt;  forcing_index         NC_INT      1   </span></span>
<span><span class="co">#&gt;  frequency             NC_CHAR     3   </span></span>
<span><span class="co">#&gt;  further_info_url      NC_CHAR    77   </span></span>
<span><span class="co">#&gt;  grid                  NC_CHAR    94   </span></span>
<span><span class="co">#&gt;  grid_label            NC_CHAR     3   </span></span>
<span><span class="co">#&gt;  initialization_index  NC_INT      1   </span></span>
<span><span class="co">#&gt;  institution           NC_CHAR   112   </span></span>
<span><span class="co">#&gt;  institution_id        NC_CHAR     9   </span></span>
<span><span class="co">#&gt;  license               NC_CHAR   805   </span></span>
<span><span class="co">#&gt;  mip_era               NC_CHAR     5   </span></span>
<span><span class="co">#&gt;  nominal_resolution    NC_CHAR     6   </span></span>
<span><span class="co">#&gt;  parent_activity_id    NC_CHAR     4   </span></span>
<span><span class="co">#&gt;  parent_experiment_id  NC_CHAR    10   </span></span>
<span><span class="co">#&gt;  parent_mip_era        NC_CHAR     5   </span></span>
<span><span class="co">#&gt;  parent_source_id      NC_CHAR     9   </span></span>
<span><span class="co">#&gt;  parent_time_units     NC_CHAR    19   </span></span>
<span><span class="co">#&gt;  parent_variant_label  NC_CHAR     8   </span></span>
<span><span class="co">#&gt;  physics_index         NC_INT      1   </span></span>
<span><span class="co">#&gt;  product               NC_CHAR    12   </span></span>
<span><span class="co">#&gt;  realization_index     NC_INT      1   </span></span>
<span><span class="co">#&gt;  realm                 NC_CHAR     5   </span></span>
<span><span class="co">#&gt;  source                NC_CHAR   560   </span></span>
<span><span class="co">#&gt;  source_id             NC_CHAR     9   </span></span>
<span><span class="co">#&gt;  source_type           NC_CHAR    18   </span></span>
<span><span class="co">#&gt;  sub_experiment        NC_CHAR     4   </span></span>
<span><span class="co">#&gt;  sub_experiment_id     NC_CHAR     4   </span></span>
<span><span class="co">#&gt;  title                 NC_CHAR    82   </span></span>
<span><span class="co">#&gt;  tracking_id           NC_CHAR    49   </span></span>
<span><span class="co">#&gt;  variable_id           NC_CHAR     2   </span></span>
<span><span class="co">#&gt;  variant_info          NC_CHAR     3   </span></span>
<span><span class="co">#&gt;  references            NC_CHAR    30   </span></span>
<span><span class="co">#&gt;  variant_label         NC_CHAR     8   </span></span>
<span><span class="co">#&gt;  value                                              </span></span>
<span><span class="co">#&gt;  areacella                                          </span></span>
<span><span class="co">#&gt;  File was processed by fremetar (GFDL analog of ... </span></span>
<span><span class="co">#&gt;  day                                                </span></span>
<span><span class="co">#&gt;  ScenarioMIP                                        </span></span>
<span><span class="co">#&gt;  standard                                           </span></span>
<span><span class="co">#&gt;  60225                                              </span></span>
<span><span class="co">#&gt;  60225                                              </span></span>
<span><span class="co">#&gt;  &lt;null ref&gt;                                         </span></span>
<span><span class="co">#&gt;  gfdl.climate.model.info@noaa.gov                   </span></span>
<span><span class="co">#&gt;  CF-1.7 CMIP-6.0 UGRID-1.0                          </span></span>
<span><span class="co">#&gt;  2019-06-18T05:29:00Z                               </span></span>
<span><span class="co">#&gt;  01.00.27                                           </span></span>
<span><span class="co">#&gt;  update of RCP4.5 based on SSP2                     </span></span>
<span><span class="co">#&gt;  ssp245                                             </span></span>
<span><span class="co">#&gt;  1                                                  </span></span>
<span><span class="co">#&gt;  day                                                </span></span>
<span><span class="co">#&gt;  https://furtherinfo.es-doc.org/CMIP6.NOAA-GFDL.... </span></span>
<span><span class="co">#&gt;  atmos data regridded from Cubed-sphere (c96) to... </span></span>
<span><span class="co">#&gt;  gr1                                                </span></span>
<span><span class="co">#&gt;  1                                                  </span></span>
<span><span class="co">#&gt;  National Oceanic and Atmospheric Administration... </span></span>
<span><span class="co">#&gt;  NOAA-GFDL                                          </span></span>
<span><span class="co">#&gt;  CMIP6 model data produced by NOAA-GFDL is licen... </span></span>
<span><span class="co">#&gt;  CMIP6                                              </span></span>
<span><span class="co">#&gt;  100 km                                             </span></span>
<span><span class="co">#&gt;  CMIP                                               </span></span>
<span><span class="co">#&gt;  historical                                         </span></span>
<span><span class="co">#&gt;  CMIP6                                              </span></span>
<span><span class="co">#&gt;  GFDL-ESM4                                          </span></span>
<span><span class="co">#&gt;  days since 1850-1-1                                </span></span>
<span><span class="co">#&gt;  r1i1p1f1                                           </span></span>
<span><span class="co">#&gt;  1                                                  </span></span>
<span><span class="co">#&gt;  model-output                                       </span></span>
<span><span class="co">#&gt;  1                                                  </span></span>
<span><span class="co">#&gt;  atmos                                              </span></span>
<span><span class="co">#&gt;  GFDL-ESM4 (2018):\natmos: GFDL-AM4.1 (Cubed-sphe...</span></span>
<span><span class="co">#&gt;  GFDL-ESM4                                          </span></span>
<span><span class="co">#&gt;  AOGCM AER CHEM BGC                                 </span></span>
<span><span class="co">#&gt;  none                                               </span></span>
<span><span class="co">#&gt;  none                                               </span></span>
<span><span class="co">#&gt;  NOAA GFDL GFDL-ESM4 model output prepared for C... </span></span>
<span><span class="co">#&gt;  hdl:21.14100/48767401-8960-4864-8738-e64640bef71d  </span></span>
<span><span class="co">#&gt;  pr                                                 </span></span>
<span><span class="co">#&gt;  N/A                                                </span></span>
<span><span class="co">#&gt;  see further_info_url attribute                     </span></span>
<span><span class="co">#&gt;  r1i1p1f1</span></span>
<span></span>
<span><span class="co"># The T axis, with name "time" has a CFTime instance</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">time</span></span>
<span></span>
<span><span class="co"># Create monthly factors for a baseline era and early, mid and late 21st century eras</span></span>
<span><span class="va">baseline</span> <span class="op">&lt;-</span> <span class="va">t</span><span class="op">$</span><span class="fu">factor</span><span class="op">(</span>era <span class="op">=</span> <span class="fl">1991</span><span class="op">:</span><span class="fl">2020</span><span class="op">)</span></span>
<span><span class="va">future</span> <span class="op">&lt;-</span> <span class="va">t</span><span class="op">$</span><span class="fu">factor</span><span class="op">(</span>era <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>early <span class="op">=</span> <span class="fl">2021</span><span class="op">:</span><span class="fl">2040</span>, mid <span class="op">=</span> <span class="fl">2041</span><span class="op">:</span><span class="fl">2060</span>, late <span class="op">=</span> <span class="fl">2061</span><span class="op">:</span><span class="fl">2080</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">baseline</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Factor w/ 12 levels "01","02","03",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  - attr(*, "era")= int 30</span></span>
<span><span class="co">#&gt;  - attr(*, "period")= chr "month"</span></span>
<span><span class="co">#&gt;  - attr(*, "CFTime")=CFClimatology with origin [days since 1850-01-01] using calendar [noleap] having 12 offset values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">future</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ early: Factor w/ 12 levels "01","02","03",..: NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "era")= int 20</span></span>
<span><span class="co">#&gt;   ..- attr(*, "period")= chr "month"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "CFTime")=CFClimatology with origin [days since 1850-01-01] using calendar [noleap] having 12 offset values $ mid  : Factor w/ 12 levels "01","02","03",..: NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "era")= int 20</span></span>
<span><span class="co">#&gt;   ..- attr(*, "period")= chr "month"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "CFTime")=CFClimatology with origin [days since 1850-01-01] using calendar [noleap] having 12 offset values $ late : Factor w/ 12 levels "01","02","03",..: NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "era")= int 20</span></span>
<span><span class="co">#&gt;   ..- attr(*, "period")= chr "month"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "CFTime")=CFClimatology with origin [days since 1850-01-01] using calendar [noleap] having 12 offset values</span></span></code></pre></div>
<p>Building on the examples above of opening a file, creating a
<code>CFTime</code> instance and a suitable factor for one data suite,
here daily rainfall, the actual processing of the data into
precipitation anomalies for 3 periods relative to a baseline period
could look like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the data for the "pr" data variable from the netCDF data set.</span></span>
<span><span class="co"># The `CFVariable$array()` method ensures that data are in standard R orientation.</span></span>
<span><span class="co"># Converts units of kg m-2 s-1 to mm/day.</span></span>
<span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">[[</span><span class="st">"pr"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">array</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fl">86400</span></span>
<span></span>
<span><span class="co"># Get a global attribute from the file</span></span>
<span><span class="va">experiment</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">$</span><span class="fu">attribute</span><span class="op">(</span><span class="st">"experiment_id"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate the daily average precipitation per month for the baseline period</span></span>
<span><span class="co"># and the three future eras.</span></span>
<span><span class="va">pr_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pr</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">tapply</span>, <span class="va">baseline</span>, <span class="va">mean</span><span class="op">)</span>                         <span class="co"># an array</span></span>
<span><span class="va">pr_future</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">future</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pr</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">tapply</span>, <span class="va">f</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span>  <span class="co"># a list of arrays</span></span>
<span></span>
<span><span class="co"># Calculate the precipitation anomalies for the future eras against the baseline.</span></span>
<span><span class="co"># Working with daily averages per month so we can simply subtract and then multiply by days </span></span>
<span><span class="co"># per month for each of the factor levels using the CF calendar.</span></span>
<span><span class="va">ano</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">pr</span>, <span class="va">f</span><span class="op">)</span> <span class="op">{</span><span class="op">(</span><span class="va">pr</span> <span class="op">-</span> <span class="va">pr_base</span><span class="op">)</span> <span class="op">*</span> <span class="va">t</span><span class="op">$</span><span class="fu">factor_units</span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">}</span>, <span class="va">pr_future</span>, <span class="va">future</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="va">ano</span><span class="op">$</span><span class="va">early</span><span class="op">[</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"o"</span>, col <span class="op">=</span> <span class="st">"blue"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">50</span>, <span class="fl">40</span><span class="op">)</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">12</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Hamilton, New Zealand\nExperiment: "</span>, <span class="va">experiment</span><span class="op">)</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"month"</span>, ylab <span class="op">=</span> <span class="st">"Precipitation anomaly (mm)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="va">ano</span><span class="op">$</span><span class="va">mid</span><span class="op">[</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"o"</span>, col <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="va">ano</span><span class="op">$</span><span class="va">late</span><span class="op">[</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"o"</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="processing_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>Looks like Hadley will be needing rubber boots in spring and autumn
back home!</p>
<p>The interesting feature, working from opening the netCDF file down to
plotting, is that the specifics of the CF calendar that the data suite
uses do not have to be considered anywhere in the processing workflow:
the <code>CFtime</code> package provides the functionality. Data suites
using another CF calendar are processed exactly the same.</p>
</div>
<div class="section level2">
<h2 id="combining-data-from-different-models-with-different-calendars">Combining data from different models with different calendars<a class="anchor" aria-label="anchor" href="#combining-data-from-different-models-with-different-calendars"></a>
</h2>
<p>Different climate projection data sets can use different calendars.
It is absolutely essential to respect the calendar of the different data
sets because the underlying solar and atmospheric physics are based on
those calendars as well.</p>
<p>In a typical situation, a researcher would construct a multi-model
ensemble to remove or reduce the bias in any given model. The data sets
composing the ensemble might well use different calendars. The correct
way of constructing an ensemble is to perform the desired analysis on
every ensemble member individually and to combine them only in the final
step and to then perform any ensemble operations such as computing
confidence intervals. The design of the <code>CFtime</code> package
makes it easy to do this, through its heavy use of lists. Building on
the previous example, let’s make a multi-model ensemble of 2 models (not
much of an ensemble but such are the limitations of including data with
packages - the example easily extends to a larger set of ensemble
members).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the list of files that make up the ensemble members, here:</span></span>
<span><span class="co"># GFDL ESM4 and MRI ESM2 models for experiment SSP2-4.5, precipitation, CMIP6 2015-01-01 to 2099-12-31</span></span>
<span><span class="va">lf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"CFtime"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop over the files individually</span></span>
<span><span class="co"># ano is here a list with each element holding the results for a single model</span></span>
<span><span class="va">ano</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">lf</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fn</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">ncdfCF</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdfCF/man/open_ncdf.html" class="external-link">open_ncdf</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">time</span></span>
<span>  <span class="va">pr</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">[[</span><span class="st">"pr"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">array</span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fl">86400</span></span>
<span></span>
<span>  <span class="va">baseline</span> <span class="op">&lt;-</span> <span class="va">t</span><span class="op">$</span><span class="fu">factor</span><span class="op">(</span>era <span class="op">=</span> <span class="fl">1991</span><span class="op">:</span><span class="fl">2020</span><span class="op">)</span></span>
<span>  <span class="va">pr_base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pr</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">tapply</span>, <span class="va">baseline</span>, <span class="va">mean</span><span class="op">)</span></span>
<span>  <span class="va">future</span> <span class="op">&lt;-</span> <span class="va">t</span><span class="op">$</span><span class="fu">factor</span><span class="op">(</span>era <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>early <span class="op">=</span> <span class="fl">2021</span><span class="op">:</span><span class="fl">2040</span>, mid <span class="op">=</span> <span class="fl">2041</span><span class="op">:</span><span class="fl">2060</span>, late <span class="op">=</span> <span class="fl">2061</span><span class="op">:</span><span class="fl">2080</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pr_future</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">future</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pr</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="va">tapply</span>, <span class="va">f</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">pr</span>, <span class="va">f</span><span class="op">)</span> <span class="op">{</span><span class="op">(</span><span class="va">pr</span> <span class="op">-</span> <span class="va">pr_base</span><span class="op">)</span> <span class="op">*</span> <span class="va">t</span><span class="op">$</span><span class="fu">factor_units</span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">}</span>, <span class="va">pr_future</span>, <span class="va">future</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Era names</span></span>
<span><span class="va">eras</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"early"</span>, <span class="st">"mid"</span>, <span class="st">"late"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">eras</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span></span>
<span><span class="co"># Build the ensemble for each era</span></span>
<span><span class="co"># For each era, grab the data for each of the ensemble members, simplify to an array</span></span>
<span><span class="co"># and take the mean per row (months, in this case)</span></span>
<span><span class="va">ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">eras</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ano</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="va">a</span><span class="op">[[</span><span class="va">e</span><span class="op">]</span><span class="op">]</span>, simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">ensemble</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">eras</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">ensemble</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">ano</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">ensemble</span></span>
<span><span class="co">#&gt;         early         mid        late</span></span>
<span><span class="co">#&gt; 01 -22.901333 -15.2675652  -1.6380748</span></span>
<span><span class="co">#&gt; 02 -25.430060 -21.4016013 -15.3427744</span></span>
<span><span class="co">#&gt; 03 -21.895792 -14.7434749 -22.4187823</span></span>
<span><span class="co">#&gt; 04   6.763958   6.9498244  15.2008249</span></span>
<span><span class="co">#&gt; 05  -2.635598 -15.3054439 -17.0106058</span></span>
<span><span class="co">#&gt; 06 -43.152012 -47.3442148 -32.1797467</span></span>
<span><span class="co">#&gt; 07   1.072942  10.4940924   3.9473240</span></span>
<span><span class="co">#&gt; 08   4.124084  -6.0917940 -12.9178847</span></span>
<span><span class="co">#&gt; 09   9.231852  -0.2038321   2.7198366</span></span>
<span><span class="co">#&gt; 10   5.148302  10.3044202  12.0060866</span></span>
<span><span class="co">#&gt; 11  16.186108  25.9156463   8.2168498</span></span>
<span><span class="co">#&gt; 12  -3.211510  -0.2036319   0.7604947</span></span></code></pre></div>
<p>Here we simply compute the average of the monthly precipitation
anomaly over the ensemble members. In a more typical scenario, you would
use the values from the individual models and to apply a more suitable
analysis, such as calculating the confidence interval or model
agreement.</p>
<p>One significant advantage of this processing workflow is that it is
easily parallelized: the bulk of the work goes into computing the
anomalies, <code>ano</code>, and this is <a href="https://en.wikipedia.org/wiki/Embarrassingly_parallel" class="external-link">embarrassingly
parallel</a> because they read their own data and produce independent
outputs. Use <a href="https://cran.r-project.org/package=future" class="external-link">package
future</a> or something similar to easily make the code run on all
available CPU cores.</p>
</div>
<div class="section level2">
<h2 id="working-with-multiple-files-in-a-single-data-suite">Working with multiple files in a single data suite<a class="anchor" aria-label="anchor" href="#working-with-multiple-files-in-a-single-data-suite"></a>
</h2>
<p>Due to the large size of typical climate projection data files, it is
common to have a data suite that is contained in multiple files. A case
in point is the CORDEX data set which breaks up the experiment period of
2006 - 2100 into 19 files of 5 years each, with each file covering a
single parameter (temperature, precipitation, etc) over an entire domain
(such as Europe, South Asia, Central America and the Caribbean, etc).
The CFtime package can streamline processing of such multi-file data
suites as well.</p>
<p>Assuming that you have your CORDEX files in a directory on disk,
organized by domain and other properties such as the variable, GCM/RCM
combination, experiment, etc, the process of preparing the files for
processing could be encoded in a function as below. The argument
<code>fn</code> is a list of file names to process, and <code>var</code>
is the variable contained in the files. (There are no checks on argument
sanity here, which should really be included. This function only makes
sense for a single [domain, GCM/RCM, experiment, variable] combination.
Also be aware of data size, CORDEX files are huge and stitching all
domain data together will easily exhaust available memory and it may
thus lead to very large swap files and very poor performance - use the
<code>ncdfCF::CFVariable$subset()</code> method to read spatial or
temporal chunks of data to avoid such problems.)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/R-CF/ncdfCF" class="external-link">ncdfCF</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">abind</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prepare_CORDEX</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fn</span>, <span class="va">var</span>, <span class="va">aoi</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">ncdfCF</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdfCF/man/open_ncdf.html" class="external-link">open_ncdf</a></span><span class="op">(</span><span class="va">fn</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Get a CFTime instance from the first file</span></span>
<span>      <span class="va">t</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">time</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># Add offsets from the file and add to the CFTime instance</span></span>
<span>      <span class="va">t</span> <span class="op">&lt;-</span> <span class="va">t</span> <span class="op">+</span> <span class="va">ds</span><span class="op">[[</span><span class="st">"time"</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">time</span><span class="op">$</span><span class="va">offsets</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Put the subsetted data array in the list</span></span>
<span>    <span class="va">data</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">subset</span><span class="op">(</span>aoi <span class="op">=</span> <span class="va">aoi</span><span class="op">)</span><span class="op">$</span><span class="fu">array</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Create a list for output with the CFTime instance and</span></span>
<span>  <span class="co"># the data bound in a single 3-dimensional array</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>CFTime <span class="op">=</span> <span class="va">t</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/abind/man/abind.html" class="external-link">abind</a></span><span class="op">(</span><span class="va">data</span>, along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Calling this function like
<code>prepare_CORDEX(list.files(path = "~/CC/CORDEX/CAM", pattern = "^pr.*\\.nc$", full.names = TRUE), "pr", ncdfCF::aoi(0, 20, 30, 50))</code>
will yield a list of netCDF files with precipitation data, with the
resulting <code>CFTime</code> instance describing the full temporal
extent covered by the data files, as well as the data bound on the
temporal dimension, ready for further processing.</p>
<p>When working like this it is imperative that the offsets and the data
arrays are added to their final structures <em>in exactly the same
order</em>. It is not necessary that the offsets (and the data)
themselves are in order, but the correspondence between offsets and data
needs to be maintained. (<code><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files()</a></code> produces a list in
alphabetical order by default, which for most climate projection files
produces offsets in chronological order.)</p>
</div>
<div class="section level2">
<h2 id="acknowledgements">Acknowledgements<a class="anchor" aria-label="anchor" href="#acknowledgements"></a>
</h2>
<p>The results presented contain modified data from Copernicus Climate
Change Service information, 2023-2025. Neither the European Commission
nor ECMWF is responsible for any use that may be made of the Copernicus
information or data it contains.</p>
<p>We acknowledge the World Climate Research Programme, which, through
its Working Group on Coupled Modelling, coordinated and promoted CMIP6.
We thank the climate modeling groups for producing and making available
their model output, the Earth System Grid Federation (ESGF) for
archiving the data and providing access, and the multiple funding
agencies who support CMIP6 and ESGF.</p>
<p>The two data sets used as examples in this vignette carry the
following license statements:</p>
<ul>
<li>
<strong>pr_day_GFDL-ESM4_ssp245_r1i1p1f1_gr1_20150101-20991231_v20180701.nc:</strong>
CMIP6 model data produced by NOAA-GFDL is licensed under a Creative
Commons Attribution-ShareAlike 4.0 International License (<a href="https://creativecommons.org/licenses/" class="external-link uri">https://creativecommons.org/licenses/</a>). Consult (dead
link to pcmdi dot llnl dot gov/CMIP6/TermsOfUse/) for terms of use
governing CMIP6 output, including citation requirements and proper
acknowledgment. Further information about this data, including some
limitations, can be found via the further_info_url (recorded as a global
attribute in this file). The data producers and data providers make no
warranty, either express or implied, including, but not limited to,
warranties of merchantability and fitness for a particular purpose. All
liabilities arising from the supply of the information (including any
liability arising in negligence) are excluded to the fullest extent
permitted by law.</li>
<li>
<strong>pr_day_MRI-ESM2-0_ssp245_r1i1p1f1_gn_20150101-20991231_v20190603.nc:</strong>
CMIP6 model data produced by MRI is licensed under a Creative Commons
Attribution-ShareAlike 4.0 International License (<a href="https://creativecommons.org/licenses/" class="external-link uri">https://creativecommons.org/licenses/</a>). Consult (dead
link to pcmdi dot llnl dot gov/CMIP6/TermsOfUse/) for terms of use
governing CMIP6 output, including citation requirements and proper
acknowledgment. Further information about this data, including some
limitations, can be found via the further_info_url (recorded as a global
attribute in this file). The data producers and data providers make no
warranty, either express or implied, including, but not limited to,
warranties of merchantability and fitness for a particular purpose. All
liabilities arising from the supply of the information (including any
liability arising in negligence) are excluded to the fullest extent
permitted by law.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Patrick Van Laake.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
